name: TaskMaster Status Sync

on:
  pull_request:
    types: [opened, closed, merged]
  push:
    branches: [main, develop]

jobs:
  sync-task-status:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'task ') || contains(github.event.pull_request.title, 'Task ')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Extract Task ID
        id: extract-task
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TITLE="${{ github.event.pull_request.title }}"
          else
            TITLE="${{ github.event.head_commit.message }}"
          fi
          
          TASK_ID=$(echo "$TITLE" | grep -oP '(?i)task\s+\K[\d.]+' | head -1)
          echo "task-id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "Found Task ID: $TASK_ID"
          
      - name: Update TaskMaster Status
        if: steps.extract-task.outputs.task-id != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          if [[ "${{ github.event.action }}" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            echo "Marking task ${{ steps.extract-task.outputs.task-id }} as done"
            npx -y task-master-ai set-status --id="${{ steps.extract-task.outputs.task-id }}" --status=done --project-root="${{ github.workspace }}"
          elif [[ "${{ github.event.action }}" == "opened" ]]; then
            echo "Marking task ${{ steps.extract-task.outputs.task-id }} as in-progress"
            npx -y task-master-ai set-status --id="${{ steps.extract-task.outputs.task-id }}" --status=in-progress --project-root="${{ github.workspace }}"
          fi